{% extends 'core/base.html' %}
{% load static %}

{% block title %}API Keys - MCP Gateway{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'mcp:dashboard' %}">MCP Gateway</a></li>
                <li class="breadcrumb-item active">API Keys</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-key text-secondary"></i> API Keys
        </h2>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
        <i class="bi bi-plus-circle"></i> Create API Key
    </button>
</div>

<!-- API Keys List -->
<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        {% if api_keys %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Key Prefix</th>
                        <th>Project</th>
                        <th>Mode</th>
                        <th>Tools</th>
                        <th>Status</th>
                        <th>Last Used</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in api_keys %}
                    <tr id="key-row-{{ key.id }}">
                        <td>
                            <strong>{{ key.name }}</strong>
                            {% if key.created_by %}
                            <br><small class="text-muted">by {{ key.created_by.username }}</small>
                            {% endif %}
                        </td>
                        <td><code>{{ key.key_prefix }}...</code></td>
                        <td>
                            {% if key.project %}
                            <span class="badge bg-info text-dark">{{ key.project.slug }}</span>
                            {% elif key.is_admin %}
                            <span class="badge bg-warning text-dark" title="Admin token - can use X-Project-Id header">
                                <i class="bi bi-shield-lock"></i> Admin
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if key.mode == 'power' %}
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-lightning"></i> Read + Write
                            </span>
                            {% else %}
                            <span class="badge bg-success">
                                <i class="bi bi-shield"></i> Read Only
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if key.allowed_tools %}
                            <span class="badge bg-info">{{ key.allowed_tools|length }} tools</span>
                            {% else %}
                            <span class="badge bg-light text-dark">All</span>
                            {% endif %}
                        </td>
                        <td>
                            <span id="status-{{ key.id }}" class="badge {% if key.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if key.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if key.last_used_at %}
                            {{ key.last_used_at|timesince }} ago
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary edit-btn"
                                    onclick="openEditPage(this, '{% url 'mcp:api_key_edit' key.id %}')"
                                    title="Edit permissions">
                                <i class="bi bi-sliders"></i>
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary"
                                    onclick="toggleKey({{ key.id }})"
                                    title="Toggle Active">
                                <i class="bi bi-power"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteKey({{ key.id }}, '{{ key.name }}')"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-key text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">No API Keys Yet</h4>
            <p class="text-muted mb-4">Create an API key to allow external agents to access your tools.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                <i class="bi bi-plus-circle"></i> Create First API Key
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Key Modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="keyName" class="form-label">Name *</label>
                    <input type="text" class="form-control" id="keyName" placeholder="e.g., Claude Agent, Sales Bot">
                    <small class="text-muted">A descriptive name to identify this key</small>
                </div>

                <div class="mb-3">
                    <label for="keyProject" class="form-label">Project *</label>
                    <select class="form-select" id="keyProject" onchange="onProjectChange()">
                        <option value="">-- Select a project --</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }} ({{ project.slug }})</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">
                        Every token must be bound to a project.
                    </small>
                </div>

                <div class="mb-3" id="adminCheckSection" style="display: none;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="keyIsAdmin">
                        <label class="form-check-label" for="keyIsAdmin">
                            <strong>Admin Token</strong> - Can use X-Project-Id header to access any project
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Mode *</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="createMode" id="createModeSafe" value="safe" checked>
                            <label class="form-check-label" for="createModeSafe">
                                <i class="bi bi-shield-check text-success"></i> Read Only (safe)
                                <small class="d-block text-muted">Only read operations</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="createMode" id="createModePower" value="power">
                            <label class="form-check-label" for="createModePower">
                                <i class="bi bi-lightning text-warning"></i> Read + Write (power)
                                <small class="d-block text-muted">Full access including writes</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Tool Selection Area -->
                <div id="toolSelectionArea" style="display: none;">
                    <hr>
                    <h6 class="text-muted mb-2">Tool Selection</h6>
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle"></i>
                        Select specific tools to restrict access. Leave empty to allow <strong>all</strong> project tools.
                    </div>

                    <div id="toolSelectionLoading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="text-muted ms-2">Loading tools...</span>
                    </div>

                    <div id="toolSelectionContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createKey()">Create Key</button>
            </div>
        </div>
    </div>
</div>

<!-- Key Created Modal -->
<div class="modal fade" id="keyCreatedModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> API Key Created</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> Copy this key now. It will not be shown again!
                </div>
                <div class="mb-3">
                    <label class="form-label">Your API Key:</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="newApiKey" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyKey()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeKeyCreatedModal()">
                    I've Copied the Key
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let projectToolsCache = {};

function onProjectChange() {
    const projectId = document.getElementById('keyProject').value;
    const adminSection = document.getElementById('adminCheckSection');
    const toolArea = document.getElementById('toolSelectionArea');

    if (projectId) {
        // Project selected - hide admin, show tools
        adminSection.style.display = 'none';
        document.getElementById('keyIsAdmin').checked = false;
        toolArea.style.display = 'block';
        loadProjectTools(projectId);
    } else {
        // No project - show admin option, hide tools
        adminSection.style.display = 'block';
        toolArea.style.display = 'none';
        document.getElementById('toolSelectionContent').innerHTML = '';
    }
}

function loadProjectTools(projectId) {
    const loading = document.getElementById('toolSelectionLoading');
    const content = document.getElementById('toolSelectionContent');

    // Check cache
    if (projectToolsCache[projectId]) {
        renderToolSelection(projectToolsCache[projectId], content);
        return;
    }

    loading.style.display = 'block';
    content.innerHTML = '';

    fetch(`/mcp/projects/${projectId}/tools/`, {
        headers: {'X-CSRFToken': csrfToken}
    })
    .then(r => r.json())
    .then(data => {
        loading.style.display = 'none';
        projectToolsCache[projectId] = data.systems || [];
        renderToolSelection(data.systems || [], content);
    })
    .catch(err => {
        loading.style.display = 'none';
        content.innerHTML = '<div class="alert alert-danger">Failed to load tools</div>';
    });
}

function renderToolSelection(systems, container) {
    if (systems.length === 0) {
        container.innerHTML = '<div class="alert alert-warning mb-0">No system integrations configured for this project.</div>';
        return;
    }

    let html = '';
    for (const sys of systems) {
        html += `
        <div class="card mb-2">
            <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                <strong>${sys.system}</strong>
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="toggleSystemTools('${sys.system_alias}')">
                    Select All
                </button>
            </div>
            <div class="card-body py-2">
                <div class="row">`;

        for (const tool of sys.tools) {
            const badgeClass = tool.tool_type === 'system_write' ? 'bg-warning text-dark' : 'bg-success';
            const typeLabel = tool.tool_type === 'system_write' ? 'write' : 'read';
            html += `
                    <div class="col-md-6 mb-1">
                        <div class="form-check">
                            <input class="form-check-input tool-checkbox" type="checkbox"
                                   value="${tool.name}" data-system="${sys.system_alias}"
                                   id="tool_${tool.name}">
                            <label class="form-check-label small" for="tool_${tool.name}">
                                <code>${tool.name}</code>
                                <span class="badge ${badgeClass} ms-1">${typeLabel}</span>
                            </label>
                        </div>
                    </div>`;
        }

        html += `
                </div>
            </div>
        </div>`;
    }

    container.innerHTML = html;
}

function toggleSystemTools(systemAlias) {
    const checkboxes = document.querySelectorAll(`.tool-checkbox[data-system="${systemAlias}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
}

function getSelectedTools() {
    const checked = document.querySelectorAll('.tool-checkbox:checked');
    return Array.from(checked).map(cb => cb.value);
}

function createKey() {
    const name = document.getElementById('keyName').value.trim();
    const mode = document.querySelector('input[name="createMode"]:checked').value;
    const projectId = document.getElementById('keyProject').value;
    const isAdmin = document.getElementById('keyIsAdmin').checked;
    const allowedTools = getSelectedTools();

    if (!name) {
        alert('Please enter a name for the key');
        return;
    }

    if (!projectId && !isAdmin) {
        alert('Please select a project');
        return;
    }

    let body = `name=${encodeURIComponent(name)}&mode=${mode}`;
    if (projectId) {
        body += `&project_id=${projectId}`;
    }
    if (isAdmin) {
        body += `&is_admin=true`;
    }
    if (allowedTools.length > 0) {
        body += `&allowed_tools=${encodeURIComponent(JSON.stringify(allowedTools))}`;
    }

    fetch('{% url "mcp:create_api_key" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: body
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createKeyModal')).hide();
            document.getElementById('newApiKey').value = data.api_key;
            new bootstrap.Modal(document.getElementById('keyCreatedModal')).show();

            // Clear form
            document.getElementById('keyName').value = '';
            document.getElementById('keyProject').value = '';
            document.getElementById('keyIsAdmin').checked = false;
            document.getElementById('createModeSafe').checked = true;
            document.getElementById('toolSelectionArea').style.display = 'none';
            document.getElementById('toolSelectionContent').innerHTML = '';
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function copyKey() {
    const keyInput = document.getElementById('newApiKey');
    keyInput.select();
    document.execCommand('copy');

    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
    btn.classList.add('btn-success');
    btn.classList.remove('btn-outline-secondary');

    setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');
    }, 2000);
}

function closeKeyCreatedModal() {
    bootstrap.Modal.getInstance(document.getElementById('keyCreatedModal')).hide();
    location.reload();
}

function toggleKey(keyId) {
    fetch('{% url "mcp:toggle_api_key" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `key_id=${keyId}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const badge = document.getElementById('status-' + keyId);
            if (data.is_active) {
                badge.textContent = 'Active';
                badge.className = 'badge bg-success';
            } else {
                badge.textContent = 'Inactive';
                badge.className = 'badge bg-secondary';
            }
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function deleteKey(keyId, keyName) {
    if (!confirm(`Delete API key "${keyName}"?\n\nThis action cannot be undone and will immediately revoke access.`)) {
        return;
    }

    fetch('{% url "mcp:delete_api_key" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `key_id=${keyId}`
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('key-row-' + keyId).remove();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function openEditPage(btn, url) {
    const icon = btn.querySelector('i');
    const spinner = btn.querySelector('.spinner-border');
    icon.classList.add('d-none');
    spinner.classList.remove('d-none');
    btn.disabled = true;
    window.location.href = url;
}
</script>
{% endblock %}
